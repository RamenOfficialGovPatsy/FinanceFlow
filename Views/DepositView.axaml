<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:FinanceFlow.ViewModels"
             mc:Ignorable="d" d:DesignWidth="520" d:DesignHeight="850"
             x:Class="FinanceFlow.Views.DepositView"
             x:DataType="vm:DepositViewModel">

    <Grid RowDefinitions="Auto, *" Margin="24" 
            Background="Transparent" PointerPressed="Root_PointerPressed">
        
        <TextBlock Grid.Row="0" 
                   Text="Пополнение цели" 
                   FontSize="24" 
                   FontWeight="Bold" 
                   Margin="0,0,0,24"/>

        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="0,0,10,0">
            <StackPanel Spacing="20">

                <Border Background="{StaticResource AppCardBackground}" 
                        CornerRadius="8" 
                        Padding="16">
                    <StackPanel Spacing="8">
                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <TextBlock Text="Цель:" Foreground="{StaticResource AppTextSecondary}"/>
                            <TextBlock Text="{Binding GoalTitle}" Foreground="{StaticResource AppText}" FontWeight="SemiBold"/>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Spacing="6">
                            <TextBlock Text="Прогресс:" Foreground="{StaticResource AppTextSecondary}"/>
                            <TextBlock>
                                <Run Text="{Binding ProgressText}"/> 
                            </TextBlock>
                            <TextBlock Text="{Binding ProgressPercent}" Foreground="{StaticResource AppPrimary}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>

                <StackPanel Spacing="8">
                    <TextBlock Classes="Label" Text="Сумма пополнения"/>
                    <Grid ColumnDefinitions="*, Auto">
                        <NumericUpDown Value="{Binding Amount, Mode=TwoWay}" 
                                       FormatString="N0" Minimum="1" ParsingNumberStyle="Integer" 
                                       HorizontalAlignment="Stretch"/>
                        <TextBlock Grid.Column="1" Text="₽" FontSize="16" VerticalAlignment="Center" Margin="12,0,0,0" Foreground="{StaticResource AppTextSecondary}"/>
                    </Grid>
                </StackPanel>

                <StackPanel Spacing="8">
                    <TextBlock Classes="Label" Text="Тип пополнения"/>
                    <ComboBox ItemsSource="{Binding DepositTypes}"
                              SelectedItem="{Binding SelectedDepositType, Mode=TwoWay}"
                              HorizontalAlignment="Stretch" 
                              PlaceholderText="Выберите тип"/>
                </StackPanel>

                <StackPanel Spacing="8">
                    <TextBlock Classes="Label" Text="Комментарий"/>
                    <TextBox Text="{Binding Comment, Mode=TwoWay}" 
                            ToolTip.Tip="Максимальная длина - 200 символов"
                             Watermark="Например: Аванс за ноябрь" 
                             HorizontalAlignment="Stretch"/>
                </StackPanel>

                <StackPanel Orientation="Horizontal" 
                            Spacing="12" 
                            HorizontalAlignment="Center" 
                            Margin="0,10,0,10">
                    
                    <Button Classes="Secondary" 
                            Width="120" Height="40" Padding="0"
                            Command="{Binding CancelCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center" VerticalAlignment="Center">
                            <Path Data="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z" 
                                  Fill="#EF4444" Width="14" Height="14" Stretch="Uniform" VerticalAlignment="Center"/>
                            <TextBlock Text="Закрыть" Foreground="{StaticResource AppTextSecondary}" VerticalAlignment="Center" FontSize="14" FontWeight="SemiBold"/>
                        </StackPanel>
                    </Button>
                    
                    <Button Background="{StaticResource AppCardBackground}" 
                            Width="40" Height="40" Padding="0"
                            Command="{Binding CancelEditCommand}"
                            IsVisible="{Binding IsEditMode}"
                            ToolTip.Tip="Отменить редактирование">
                        <TextBlock Text="↩️" FontSize="16" VerticalAlignment="Center" HorizontalAlignment="Center" FontFamily="Segoe UI Emoji, Apple Color Emoji, Noto Color Emoji, System"/>
                    </Button>
                    
                    <Button Classes="Primary" 
                            Width="160" Height="40" Padding="0"
                            Command="{Binding SaveCommand}">
                        <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center" VerticalAlignment="Center">
                            <TextBlock Text="{Binding ButtonIcon}" FontSize="16" FontFamily="Segoe UI Emoji, Apple Color Emoji, Noto Color Emoji, System" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding ButtonText}" Foreground="#D1D5DB" VerticalAlignment="Center" FontSize="14" FontWeight="SemiBold"/>
                        </StackPanel>
                    </Button>
                </StackPanel>

                <Grid ColumnDefinitions="*, Auto, *" Margin="0,10">
                    <Border Grid.Column="0" Height="1" Background="{StaticResource AppBorderBrush}" VerticalAlignment="Center"/>
                    <TextBlock Grid.Column="1" Text="История пополнений" Foreground="{StaticResource AppTextSecondary}" Margin="16,0" FontSize="14"/>
                    <Border Grid.Column="2" Height="1" Background="{StaticResource AppBorderBrush}" VerticalAlignment="Center"/>
                </Grid>

                <ItemsControl ItemsSource="{Binding DepositHistory}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Spacing="10"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="vm:DepositItemViewModel">
                            <Border Background="{StaticResource AppCardBackground}" CornerRadius="8" Padding="12">
                                <Grid ColumnDefinitions="Auto, *, Auto">
                                    <TextBlock Grid.Column="0" Text="{Binding Icon}" 
                                               Foreground="{Binding IconColor}"
                                               FontSize="16" 
                                               FontFamily="Segoe UI Emoji, Apple Color Emoji, Noto Color Emoji, System"
                                               VerticalAlignment="Center" Margin="0,0,12,0"/>
                                    
                                    <StackPanel Grid.Column="1" Spacing="4" VerticalAlignment="Center">
                                        <TextBlock FontSize="14">
                                            <Run Text="{Binding Date, StringFormat='dd.MM.yyyy'}" Foreground="{StaticResource AppTextSecondary}"/>
                                            <Run Text=" • " Foreground="{StaticResource AppTextSecondary}"/>
                                            <Run Text="{Binding Amount, StringFormat='{}{0:N0} ₽'}" Foreground="{StaticResource AppPrimary}"/>
                                        </TextBlock>
                                        
                                        <TextBlock Text="{Binding DisplayType}" FontSize="12" Foreground="{StaticResource AppTextSecondary}"/>
                                        
                                        <TextBlock Text="{Binding Comment}" 
                                                   IsVisible="{Binding HasComment}"
                                                   FontSize="12" Foreground="#6B7280" FontStyle="Italic"
                                                   TextTrimming="CharacterEllipsis"/>
                                    </StackPanel>
                                    
                                    <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                                        
                                        <Button Background="#2D3748" Padding="10,6" CornerRadius="6"
                                                Command="{Binding $parent[UserControl].DataContext.StartEditCommand}"
                                                CommandParameter="{Binding}"
                                                ToolTip.Tip="Редактировать запись">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <TextBlock Text="✏️" FontSize="14" FontFamily="Segoe UI Emoji, Apple Color Emoji, Noto Color Emoji, System" VerticalAlignment="Center"/>
                                                <TextBlock Text="Редактировать" FontSize="12" Foreground="{StaticResource AppTextSecondary}" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Button>
                                        
                                        <Button Background="#2D3748" Padding="10,6" CornerRadius="6"
                                                Command="{Binding $parent[UserControl].DataContext.DeleteHistoryItemCommand}"
                                                CommandParameter="{Binding}"
                                                ToolTip.Tip="Удалить запись и вернуть деньги в баланс цели">
                                            <StackPanel Orientation="Horizontal" Spacing="6">
                                                <TextBlock Text="❌" FontSize="14" Foreground="#EF4444" FontFamily="Segoe UI Emoji, Apple Color Emoji, Noto Color Emoji, System" VerticalAlignment="Center"/>
                                                <TextBlock Text="Удалить" FontSize="12" Foreground="#EF4444" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
                
                <Border Height="20"/>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>